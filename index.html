<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è·¯æ˜“å£«æ—©é¤å§</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>body { font-family: 'Noto Sans TC', sans-serif; }</style>
</head>
<body class="bg-blue-50">
  <div class="p-4 max-w-md mx-auto">
    <h1 class="text-3xl font-extrabold text-blue-900 mb-4 text-center">è·¯æ˜“å£«æ—©é¤å§</h1>

    <!-- åˆ†é¡åˆ‡æ›æŒ‰éˆ•åˆ— -->
    <div id="categoryBar" class="flex gap-2 mb-4 flex-wrap justify-center"></div>

    <!-- èœå–®å€å¡Š -->
    <div id="menu" class="space-y-4"></div>
  </div>

  <!-- è³¼ç‰©è»ŠæŒ‰éˆ• -->
  <button id="cartBtn"
    class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white w-14 h-14 rounded-full shadow-lg z-50 flex items-center justify-center">
    ğŸ›’ <span id="cartCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1">0</span>
  </button>

  <!-- ä¸­å¤®è³¼ç‰©è»Šé¢æ¿ -->
  <div id="cartOverlay"
    class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white w-[90vw] max-w-sm rounded-lg p-4 shadow-xl max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-2">ğŸ›’ è³¼ç‰©è»Š</h2>
      <ul id="cartList" class="mb-2"></ul>
      <input id="tableInput" type="text" placeholder="æ¡Œè™Ÿï¼ˆå¦‚ A1ï¼‰"
        class="w-full mb-2 px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300" />

      <!-- ç¸½é‡‘é¡å€å¡Š -->
      <div class="bg-blue-100 p-3 rounded text-center mt-4">
        <div class="text-sm text-blue-700">ç¸½é‡‘é¡</div>
        <div class="text-2xl font-bold text-blue-900"><span id="cartTotal">0</span> å…ƒ</div>
      </div>

      <button id="submitOrder"
        class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full">âœ… é€å‡ºè¨‚å–®</button>
      <div id="orderMsg" class="mt-2 text-blue-700 font-semibold text-center hidden"></div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAEpf1ffQFht5yBm-xCBBMVsdxjzbVhsBg",
      authDomain: "louis-breakfast-tpe.firebaseapp.com",
      projectId: "louis-breakfast-tpe"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const menuEl = document.getElementById("menu");
    const cartBtn = document.getElementById("cartBtn");
    const cartOverlay = document.getElementById("cartOverlay");
    const cartList = document.getElementById("cartList");
    const cartCount = document.getElementById("cartCount");
    const cartTotal = document.getElementById("cartTotal");
    const tableInput = document.getElementById("tableInput");
    const submitOrder = document.getElementById("submitOrder");
    const orderMsg = document.getElementById("orderMsg");
    const categoryBar = document.getElementById("categoryBar");

    let cart = [];
    let allMenu = [];
    let currentCategory = "å…¨éƒ¨";

    function renderCategoryBar(categories) {
      categoryBar.innerHTML = "";
      ["å…¨éƒ¨", ...categories].forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.className = `px-3 py-1 rounded-full text-sm font-semibold ${
          cat === currentCategory
            ? "bg-blue-600 text-white"
            : "bg-blue-100 text-blue-800 hover:bg-blue-200"
        }`;
        btn.onclick = () => {
          currentCategory = cat;
          renderMenu(allMenu);
          renderCategoryBar(categories);
        };
        categoryBar.appendChild(btn);
      });
    }

    function renderMenu(items) {
      menuEl.innerHTML = "";
      const filtered = currentCategory === "å…¨éƒ¨"
        ? items
        : items.filter(item => item.category === currentCategory);
      filtered.forEach(item => {
        const div = document.createElement("div");
        div.className = "bg-white p-4 rounded-lg shadow";
        div.innerHTML = `
          <div class="text-lg font-semibold text-gray-800">${item.id}. ${item.name}</div>
          <div class="text-xl font-bold text-blue-700 mt-1">NT$ ${item.price}</div>
          <button class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded-full">åŠ å…¥è³¼ç‰©è»Š</button>
        `;
        div.querySelector("button").onclick = () => addToCart(item);
        menuEl.appendChild(div);
      });
    }

    function addToCart(item) {
      cart.push(item);
      updateCart();
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCart();
    }

    function updateCart() {
      cartList.innerHTML = "";
      cart.forEach((item, i) => {
        const li = document.createElement("li");
        li.className = "mb-2 flex justify-between items-center";
        li.innerHTML = `<span>${item.id}. ${item.name} - NT$ ${item.price}</span>
          <button class="text-red-500 text-sm">ç§»é™¤</button>`;
        li.querySelector("button").onclick = () => removeFromCart(i);
        cartList.appendChild(li);
      });
      cartCount.textContent = cart.length;
      cartTotal.textContent = cart.reduce((sum, item) => sum + Number(item.price), 0);
    }

    cartBtn.onclick = () => {
      cartOverlay.classList.remove("hidden");
    };

    cartOverlay.onclick = (e) => {
      if (e.target.id === "cartOverlay") {
        cartOverlay.classList.add("hidden");
      }
    };

    submitOrder.onclick = async () => {
      const tableNumber = tableInput.value.trim();
      if (!tableNumber || cart.length === 0) return alert("è«‹è¼¸å…¥æ¡Œè™Ÿä¸¦é¸æ“‡å“é …");

      const now = new Date();
      const orderId = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}${String(now.getTime()).slice(-4)}`;

      const payload = {
        orderId,
        tableNumber,
        items: cart.map(item => ({ id: item.id, name: item.name, price: item.price, qty: 1 })),
        total: cart.reduce((sum, item) => sum + Number(item.price), 0),
        status: "è™•ç†ä¸­",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection("orders").add(payload);
        cart = [];
        updateCart();
        tableInput.value = "";
        cartOverlay.classList.add("hidden");
        orderMsg.textContent = `è¨‚å–®å·²é€å‡ºï¼ç·¨è™Ÿï¼š${orderId}ï¼Œæ¡Œè™Ÿï¼š${tableNumber}`;
        orderMsg.classList.remove("hidden");
      } catch
