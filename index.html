<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è·¯æ˜“å£«æ—©é¤å§</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>body { font-family: 'Noto Sans TC', sans-serif; }</style>
</head>
<body class="bg-blue-50">
  <div class="p-4 max-w-md mx-auto">
    <h1 class="text-3xl font-extrabold text-blue-900 mb-6 text-center">è·¯æ˜“å£«æ—©é¤å§</h1>
    <div id="menu" class="space-y-4"></div>
  </div>

  <!-- è³¼ç‰©è»ŠæŒ‰éˆ• -->
  <button id="cartBtn"
    class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg z-50 relative">
    ğŸ›’ <span id="cartCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1">0</span>
  </button>

  <!-- è³¼ç‰©è»Šé¢æ¿ -->
  <div id="cartPanel"
    class="fixed bottom-20 right-4 w-[90vw] max-w-sm bg-white shadow-xl rounded-lg p-4 z-50 hidden max-h-[70vh] overflow-y-auto border border-blue-200">
    <h2 class="text-xl font-bold mb-2">ğŸ›’ è³¼ç‰©è»Š</h2>
    <ul id="cartList" class="mb-2"></ul>
    <input id="tableInput" type="text" placeholder="æ¡Œè™Ÿï¼ˆå¦‚ A1ï¼‰"
      class="w-full mb-2 px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300" />
    <div class="font-bold mb-2">ç¸½é‡‘é¡ï¼šNT$ <span id="cartTotal">0</span></div>
    <button id="submitOrder"
      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full">âœ… é€å‡ºè¨‚å–®</button>
    <div id="orderMsg" class="mt-2 text-blue-700 font-semibold text-center hidden"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAEpf1ffQFht5yBm-xCBBMVsdxjzbVhsBg",
      authDomain: "louis-breakfast-tpe.firebaseapp.com",
      projectId: "louis-breakfast-tpe",
      storageBucket: "louis-breakfast-tpe.appspot.com",
      messagingSenderId: "707080689547",
      appId: "1:707080689547:web:ca293380046a59e7de818e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const menuEl = document.getElementById("menu");
    const cartBtn = document.getElementById("cartBtn");
    const cartPanel = document.getElementById("cartPanel");
    const cartList = document.getElementById("cartList");
    const cartCount = document.getElementById("cartCount");
    const cartTotal = document.getElementById("cartTotal");
    const tableInput = document.getElementById("tableInput");
    const submitOrder = document.getElementById("submitOrder");
    const orderMsg = document.getElementById("orderMsg");

    let cart = [];

    function renderMenu(items) {
      menuEl.innerHTML = "";
      items.forEach(item => {
        const div = document.createElement("div");
        div.className = "bg-white p-4 rounded-lg shadow";
        div.innerHTML = `
          <div class="text-lg font-semibold text-gray-800">${item.id}. ${item.name}</div>
          <div class="text-sm text-gray-500">NT$ ${item.price}</div>
          <button class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded-full">åŠ å…¥è³¼ç‰©è»Š</button>
        `;
        div.querySelector("button").onclick = () => addToCart(item);
        menuEl.appendChild(div);
      });
    }

    function addToCart(item) {
      cart.push(item);
      updateCart();
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCart();
    }

    function updateCart() {
      cartList.innerHTML = "";
      cart.forEach((item, i) => {
        const li = document.createElement("li");
        li.className = "mb-2 flex justify-between items-center";
        li.innerHTML = `<span>${item.id}. ${item.name} - NT$ ${item.price}</span>
          <button class="text-red-500 text-sm">ç§»é™¤</button>`;
        li.querySelector("button").onclick = () => removeFromCart(i);
        cartList.appendChild(li);
      });
      cartCount.textContent = cart.length;
      cartTotal.textContent = cart.reduce((sum, item) => sum + Number(item.price), 0);
    }

    cartBtn.onclick = () => {
      cartPanel.classList.toggle("hidden");
    };

    submitOrder.onclick = async () => {
      const tableNumber = tableInput.value.trim();
      if (!tableNumber || cart.length === 0) return alert("è«‹è¼¸å…¥æ¡Œè™Ÿä¸¦é¸æ“‡å“é …");

      const today = new Date();
      const orderId = `${today.getFullYear()}${String(today.getMonth()+1).padStart(2,'0')}${String(today.getDate()).padStart(2,'0')}${String(today.getTime()).slice(-4)}`;

      const payload = {
        orderId,
        tableNumber,
        items: cart.map(item => ({ id: item.id, name: item.name, price: item.price, qty: 1 })),
        total: cart.reduce((sum, item) => sum + Number(item.price), 0),
        status: "è™•ç†ä¸­",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection("orders").add(payload);
        cart = [];
        updateCart();
        tableInput.value = "";
        cartPanel.classList.add("hidden");
        orderMsg.textContent = `è¨‚å–®å·²é€å‡ºï¼ç·¨è™Ÿï¼š${orderId}ï¼Œæ¡Œè™Ÿï¼š${tableNumber}`;
        orderMsg.classList.remove("hidden");
      } catch (e) {
        console.error("é€å‡ºå¤±æ•—", e);
        alert("é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      }
    };

    db.collection("menu").orderBy("id").onSnapshot(snap => {
      const items = snap.docs.map(doc => doc.data()).filter(item => item.available !== false);
      renderMenu(items);
    });
  </script>
</body>
</html>
