<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂單後台管理</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 md:p-8">

    <div class="container mx-auto max-w-4xl w-full bg-white rounded-2xl shadow-xl p-6 md:p-8">

        <!-- Header Section -->
        <header class="flex justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-3xl md:text-4xl font-black text-blue-600">
                訂單後台管理
            </h1>
            <div id="auth-status" class="text-sm text-gray-500 flex items-center space-x-2">
                <i class="fas fa-spinner fa-spin text-blue-500"></i>
                <span>驗證中...</span>
            </div>
        </header>
        
        <!-- Main Content -->
        <main id="main-content">
            <!-- Orders will be rendered here -->
            <div id="orders-container" class="space-y-4">
                <div class="text-center text-gray-500 py-10">
                    <i class="fas fa-sync-alt fa-spin text-2xl mb-2"></i>
                    <p>正在載入訂單...</p>
                </div>
            </div>
        </main>

    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 m-4 max-w-sm w-full text-center">
            <h3 id="message-title" class="text-2xl font-bold mb-2"></h3>
            <p id="message-text" class="text-gray-700 mb-4"></p>
            <button onclick="hideMessage()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">好的</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;

        const authStatusEl = document.getElementById('auth-status');
        const ordersContainerEl = document.getElementById('orders-container');
        const messageModal = document.getElementById('message-modal');
        const messageTitleEl = document.getElementById('message-title');
        const messageTextEl = document.getElementById('message-text');

        // All static text in Traditional Chinese
        const staticText = {
            'authenticating': '驗證中...',
            'authSuccess': '驗證成功',
            'authError': '驗證失敗',
            'noOrders': '目前沒有任何訂單',
            'loadingOrders': '正在載入訂單...',
            'yourUserId': '您的使用者 ID：',
            'copyId': '複製 ID'
        };

        /**
         * Displays a modal message to the user.
         * @param {string} title The title of the message.
         * @param {string} text The body of the message.
         */
        function showMessage(title, text) {
            messageTitleEl.textContent = title;
            messageTextEl.textContent = text;
            messageModal.classList.remove('hidden');
        }

        /**
         * Hides the modal message.
         */
        function hideMessage() {
            messageModal.classList.add('hidden');
        }

        /**
         * Initializes Firebase and sets up the authentication state listener.
         */
        function initializeFirebaseAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.innerHTML = `
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span>${staticText.authSuccess}</span>
                        `;
                        // Display the user ID and a copy button
                        const userIdEl = document.createElement('div');
                        userIdEl.className = 'text-xs text-gray-500 mt-2 flex items-center space-x-2';
                        userIdEl.innerHTML = `
                            <span class="font-bold">${staticText.yourUserId}</span>
                            <span id="user-id-text" class="select-all break-all">${userId}</span>
                            <button onclick="copyUserId()" class="text-blue-500 hover:text-blue-700 focus:outline-none">
                                <i class="fas fa-copy"></i>
                            </button>
                        `;
                        document.getElementById('main-content').prepend(userIdEl);
                        
                        // Start listening for orders
                        startListeningForOrders();
                    } else {
                        // Sign in with the provided custom token
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                             // Fallback to anonymous sign-in if no token is available
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                authStatusEl.innerHTML = `
                    <i class="fas fa-times-circle text-red-500"></i>
                    <span>${staticText.authError}</span>
                `;
                showMessage('驗證失敗', '無法連接到後台。請檢查您的網路連線或稍後再試。');
            }
        }

        /**
         * Copies the user ID to the clipboard.
         */
        function copyUserId() {
            const userIdText = document.getElementById('user-id-text').innerText;
            try {
                // Use document.execCommand for better iFrame compatibility
                const el = document.createElement('textarea');
                el.value = userIdText;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                showMessage('複製成功', '您的使用者 ID 已複製到剪貼簿。');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessage('複製失敗', '無法複製使用者 ID。請手動選取並複製。');
            }
        }

        /**
         * Listens for real-time order updates from Firestore and renders them.
         */
        function startListeningForOrders() {
            if (!db || !userId) {
                console.error("Firestore not initialized or user not authenticated.");
                return;
            }

            // Fix: The previous collection path was incorrect. It did not match the required
            // format 'artifacts/{appId}/public/data/orders'.
            // The new path has 5 segments, which is the correct format for a collection reference.
            const ordersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
            
            // Listen for real-time updates
            onSnapshot(ordersCollectionRef, (querySnapshot) => {
                const orders = [];
                querySnapshot.forEach((doc) => {
                    // Get order data and add document ID
                    const orderData = doc.data();
                    orders.push({ id: doc.id, ...orderData });
                });

                // Sort orders by timestamp in descending order
                orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                renderOrders(orders);
            }, (error) => {
                console.error("Error listening to orders:", error);
                ordersContainerEl.innerHTML = `<p class="text-center text-red-500 py-10">載入訂單失敗。</p>`;
            });
        }

        /**
         * Renders the list of orders to the dashboard.
         * @param {Array} orders The array of order objects.
         */
        function renderOrders(orders) {
            ordersContainerEl.innerHTML = ''; // Clear previous orders

            if (orders.length === 0) {
                ordersContainerEl.innerHTML = `
                    <div class="text-center text-gray-500 py-10">
                        <i class="fas fa-box-open text-4xl mb-2"></i>
                        <p>${staticText.noOrders}</p>
                    </div>
                `;
                return;
            }

            orders.forEach(order => {
                // Format the timestamp for better readability
                const orderTime = new Date(order.timestamp).toLocaleString('zh-TW', {
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    day: 'numeric', month: 'long', year: 'numeric'
                });

                // Generate HTML for each item in the order
                const itemsHtml = order.items.map(item => `
                    <li class="flex justify-between items-center py-1">
                        <span class="text-gray-700">${item.name} <span class="text-sm text-gray-500">x ${item.quantity}</span></span>
                        <span class="text-gray-700 font-medium">NT$ ${item.quantity * item.price}</span>
                    </li>
                `).join('');

                const orderCard = document.createElement('div');
                orderCard.className = 'bg-gray-50 p-6 rounded-2xl shadow-sm border border-gray-200';
                orderCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="text-xl font-bold text-gray-800">${order.customerName || '匿名顧客'}</h3>
                        <span class="text-sm text-gray-500">${orderTime}</span>
                    </div>
                    <ul class="space-y-2 mb-4">${itemsHtml}</ul>
                    <div class="flex justify-between items-center text-lg font-bold">
                        <span>總計：</span>
                        <span class="text-green-600">NT$ ${order.totalPrice}</span>
                    </div>
                `;
                ordersContainerEl.appendChild(orderCard);
            });
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebaseAndAuth();
        });
    </script>
</body>
</html>
